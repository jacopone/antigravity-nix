name: Create Release

on:
  # Trigger when Update workflow completes (bypasses GITHUB_TOKEN limitation)
  workflow_run:
    workflows: ["Update Google Antigravity"]
    types:
      - completed
  # Keep push trigger for manual merges by humans
  push:
    branches:
      - master
    paths:
      - 'package.nix'
  # Allow manual trigger
  workflow_dispatch:

permissions:
  contents: write

jobs:
  create-release:
    name: Create GitHub release
    runs-on: ubuntu-latest
    # Only run if: workflow_dispatch, push event, OR workflow_run that succeeded
    if: |
      github.event_name == 'workflow_dispatch' ||
      github.event_name == 'push' ||
      (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success')

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check if version changed
        id: version_check
        run: |
          CURRENT_VERSION=$(grep -oP 'version = "\K[^"]+' flake.nix | head -1)
          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          git show HEAD~1:flake.nix > /tmp/old_flake.nix 2>/dev/null || true

          if [ -f /tmp/old_flake.nix ]; then
            PREVIOUS_VERSION=$(grep -oP 'version = "\K[^"]+' /tmp/old_flake.nix | head -1)
            echo "previous_version=$PREVIOUS_VERSION" >> $GITHUB_OUTPUT

            if [ "$CURRENT_VERSION" != "$PREVIOUS_VERSION" ]; then
              echo "version_changed=true" >> $GITHUB_OUTPUT
              echo "Version changed: $PREVIOUS_VERSION -> $CURRENT_VERSION"
            else
              echo "version_changed=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "version_changed=true" >> $GITHUB_OUTPUT
          fi

      - name: Check if release exists
        if: steps.version_check.outputs.version_changed == 'true'
        id: release_check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version_check.outputs.current_version }}
        run: |
          if gh release view "v$VERSION" >/dev/null 2>&1; then
            echo "release_exists=true" >> $GITHUB_OUTPUT
          else
            echo "release_exists=false" >> $GITHUB_OUTPUT
          fi

      - name: Create release
        if: |
          steps.version_check.outputs.version_changed == 'true' &&
          steps.release_check.outputs.release_exists == 'false'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          VERSION: ${{ steps.version_check.outputs.current_version }}
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "v$VERSION" -m "Google Antigravity v$VERSION"
          git push origin "v$VERSION"

          gh release create "v$VERSION" \
            --title "Google Antigravity v$VERSION" \
            --notes "Auto-updated Google Antigravity to version $VERSION.

          ## Installation

          \`\`\`nix
          inputs.antigravity-nix.url = \"github:jacopone/antigravity-nix/v$VERSION\";
          \`\`\`

          ## What's New

          See: https://antigravity.google/releases

          ## Features

          - ðŸ¤– Agentic IDE: Next-generation AI-powered development
          - ðŸš€ Auto-updating: Updates 3x weekly  
          - ðŸ“¦ Multi-platform: Linux & macOS (x86_64, aarch64)
          - ðŸ”§ FHS Environment: Maximum compatibility"

          echo "âœ“ Created release v$VERSION"
