name: Update Google Antigravity

on:
  schedule:
    # Run 3x weekly (Mon/Wed/Fri) at 9:00 UTC
    - cron: '0 9 * * 1,3,5'
  workflow_dispatch: # Allow manual trigger

permissions:
  contents: write
  pull-requests: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Install Nix
        uses: DeterminateSystems/nix-installer-action@main
        env:
          DISABLE_FLAKEHUB: "true"
        with:
          flakehub: false
          extra-conf: |
            experimental-features = nix-command flakes
            accept-flake-config = true

      - name: Setup Nix cache
        uses: DeterminateSystems/magic-nix-cache-action@main

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Install Playwright
        run: |
          # Install locally (not globally) so node can find the module
          npm install playwright-chromium
          npx playwright install chromium

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Run update script
        id: update
        run: |
          chmod +x scripts/update-version.sh

          # Capture output and show it for debugging
          if ./scripts/update-version.sh 2>&1 | tee update_output.txt; then
            echo "update_success=true" >> $GITHUB_OUTPUT

            # Extract new version if updated
            if grep -q "Update complete" update_output.txt; then
              # Extract version carefully - only the semver-build pattern
              NEW_VERSION=$(grep -oP 'version = "\K[0-9]+\.[0-9]+\.[0-9]+-[0-9]+' flake.nix | head -1)
              echo "Detected new version: $NEW_VERSION"
              echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
              echo "has_changes=true" >> $GITHUB_OUTPUT
            else
              echo "has_changes=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "update_success=false" >> $GITHUB_OUTPUT
            echo "=== Update script failed ==="
            cat update_output.txt
            exit 1
          fi

      - name: Create Pull Request
        if: steps.update.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: "chore: update antigravity to ${{ steps.update.outputs.new_version }}"
          title: "chore: update antigravity to ${{ steps.update.outputs.new_version }}"
          body: |
            ## Google Antigravity Update

            This PR updates Google Antigravity to version **${{ steps.update.outputs.new_version }}**.

            ### Changes
            - Updated version in `flake.nix`
            - Updated version and hash in `package.nix`
            - Ran `nix flake update`

            ### Testing
            - ‚úÖ Built successfully
            - ‚úÖ Flake checks passed

            ### Changelog
            See: https://antigravity.google/releases

            ---
            ü§ñ This PR was created automatically by the auto-update workflow.
          branch: auto-update/antigravity-${{ steps.update.outputs.new_version }}
          delete-branch: true
          labels: |
            automated
            antigravity-update

      - name: Enable auto-merge
        if: steps.update.outputs.has_changes == 'true'
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          NEW_VERSION: ${{ steps.update.outputs.new_version }}
        run: |
          # Retry loop with exponential backoff to find the PR
          MAX_ATTEMPTS=5
          ATTEMPT=1
          WAIT_TIME=5

          while [ $ATTEMPT -le $MAX_ATTEMPTS ]; do
            echo "Attempt $ATTEMPT/$MAX_ATTEMPTS: Looking for PR..."

            PR_NUMBER=$(gh pr list --head "auto-update/antigravity-$NEW_VERSION" --json number --jq '.[0].number')

            if [ -n "$PR_NUMBER" ]; then
              echo "Found PR #$PR_NUMBER"
              echo "Enabling auto-merge..."

              if gh pr merge "$PR_NUMBER" --auto --squash; then
                echo "‚úì Auto-merge enabled for PR #$PR_NUMBER"
                exit 0
              else
                echo "‚ö† Failed to enable auto-merge, but PR exists"
                exit 0
              fi
            fi

            if [ $ATTEMPT -lt $MAX_ATTEMPTS ]; then
              echo "PR not found yet, waiting ${WAIT_TIME}s before retry..."
              sleep $WAIT_TIME
              WAIT_TIME=$((WAIT_TIME * 2))  # Exponential backoff
            fi

            ATTEMPT=$((ATTEMPT + 1))
          done

          echo "‚ö† Could not find PR after $MAX_ATTEMPTS attempts"
          echo "The PR may have been created but not yet visible via API"

      - name: Report status
        if: always()
        env:
          UPDATE_SUCCESS: ${{ steps.update.outputs.update_success }}
          HAS_CHANGES: ${{ steps.update.outputs.has_changes }}
          NEW_VERSION: ${{ steps.update.outputs.new_version }}
        run: |
          if [[ "$UPDATE_SUCCESS" == "true" ]]; then
            if [[ "$HAS_CHANGES" == "true" ]]; then
              echo "‚úÖ Update successful! New version: $NEW_VERSION"
            else
              echo "‚úÖ Already at latest version"
            fi
          else
            echo "‚ùå Update failed"
            exit 1
          fi
